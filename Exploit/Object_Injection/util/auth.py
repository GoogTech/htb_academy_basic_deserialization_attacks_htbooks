import pickle
import base64

# Define a class named 'Session' to represent a user session
class Session:
    # Initialize the session with username and role attributes
    def __init__(self, username, role):
        self.username = username
        self.role = role

# Convert a session object into a base64-encoded cookie string
def sessionToCookie(session):
    # Serialize the session object using pickle
    p = pickle.dumps(session)
    # Encode the serialized bytes into base64 format
    b = base64.b64encode(p)
    # Return the base64-encoded session data (cookie)
    return b

# Convert a base64-encoded cookie back into a session object
def cookieToSession(cookie):
    # Decode the cookie from base64 to get the original pickle bytes
    b = base64.b64decode(cookie)
    # Print the decoded bytes for debugging purposes
    print(f"\nSession: Cookie base64 decode result ---> {b}")
    # Check for potentially dangerous substrings that could indicate command injection.
    # Note that the prefix b indicates that the value is a bytes literal, not a regular string (str),
    # and the result of base64.b64decode(cookie) is binary data (a bytes object), for example: b'\x80\x04...'
    for badword in [b"nc", b"ncat", b"/bash", b"/sh", b"subprocess", b"Popen"]:
        if badword in b:
            # Return None if malicious content is detected
            return None
    # Deserialize the pickle bytes back into a Session object
    p = pickle.loads(b)
    # Return the reconstructed session object
    return p